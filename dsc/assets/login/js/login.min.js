"use strict";new Vue({el:".list-case-show",components:{"login-form":httpVueLoader("/tw/dsc/assets/login/components/login-form.vue")},data:{showPopup:!1},computed:{dev:function(){return"www.digiwin.com"!==location.hostname},email:function(){return localStorage.getItem("email")||""},userID:function(){return localStorage.getItem("line_userID")||""},channelID:function(){return"1570741188"},channelSecret:function(){return"8082e9d4b345e1b3768f160ddd76a6ee"},state:function(){return"abcde"},code:function(){return this.getParameterByName("code")},callbackURL:function(){return location.origin+location.pathname},apiURL:function(){return"https://misws.digiwin.com/SocialMediaMarketing/api/loglist/Save"}},methods:{init:function(){var e=this.getParameterByName("state");this.code&&e===this.state?this.getCode():this.showCover()},getCode:function(){var e=this.callbackURL.split("/").pop();history.replaceState({},"",e),this.getToken()},getToken:function(){var t=this,e=new URLSearchParams;e.append("grant_type","authorization_code"),e.append("code",this.code),e.append("redirect_uri",this.callbackURL),e.append("client_id",this.channelID),e.append("client_secret",this.channelSecret),axios.post("https://api.line.me/oauth2/v2.1/token",e).then(function(e){return 200===e.status?(t.accessToken=e.data.access_token,localStorage.setItem("line_token",t.accessToken),void t.getProfile(t.accessToken)):t.showCover()}).catch(function(e){t.showCover(),console.error(e)})},getProfile:function(e){var t=this;axios.get("https://api.line.me/v2/profile",{headers:{Authorization:"Bearer ".concat(e)}}).then(function(e){return 200===e.status?(localStorage.setItem("line_userID",e.data.userId),localStorage.setItem("line_displayName",e.data.displayName),t.setExpTime("line_exp"),t.saveLineLog(e.data.userId),void t.addSubscribeForm()):t.showCover()}).catch(function(){return t.showCover()})},saveLineLog:function(e){var t={logtype:"lineId",lineId:e,mail:"",source:location.href};this.ajaxSensor(t)},saveViewLog:function(){var e={logtype:this.userID?"lineId":"mail",lineId:this.userID,mail:this.userID?"":this.email,source:location.href};this.ajaxSensor(e)},checkLogin:function(){var e=new Date,t=localStorage.getItem("line_exp")||localStorage.getItem("email_exp");return t&&!(e.getTime()>parseInt(t,10))||(this.cleanLS(),!1)},addCover:function(){document.querySelector(".list-case-show").insertAdjacentHTML("beforeend",'\n                <div class="articleCover">\n                    <a href @click.prevent="showPopup=true">全文閱讀</a>\n                </div>\n                <login-form\n                    v-model="showPopup"\n                    :info="{ channelID: channelID, state: state, callbackURL: callbackURL }"\n                    @set-exp="setExpTime"\n                    @post="ajaxSensor"\n                ></login-form>\n            '),this.dev&&document.querySelector(".list-case-show").insertAdjacentHTML("beforeend",'\n                    <button\n                        @click="logout"\n                        style="position: fixed;left: 0;bottom: 0;z-index: 1;"\n                    >登出</button>\n                ')},showCover:function(){1400<this.$el.offsetHeight&&(this.$el.style.height="1400px",this.$el.style.overflow="hidden"),this.$el.classList.add("no-login")},addSubscribeForm:function(){fetch("/tw/dsc/assets/login/subscribe.json").then(function(e){return e.json()}).then(function(e){var a=location.pathname.replace(/(.html|.htm)$/,"");e.forEach(function(e){var t=e.url,o=e.title,n=e.lineUrl;(t=t.replace(/(.html|.htm)$/,""))===a&&(document.querySelector(".list-case-show").insertAdjacentHTML("afterend",'<div id="subscribeForm"></div>'),new Vue({el:"#subscribeForm",components:{"subscribe-form":httpVueLoader("/tw/dsc/assets/login/components/subscribe-form.vue")},template:'<subscribe-form title="'.concat(o,'" line-url="').concat(n,'"></subscribe-form>')}))})})},logout:function(){this.cleanLS(),location.reload()},manualLogout:function(){if("#logout"==location.hash){this.cleanLS();var e=location.pathname.split("/").pop();history.replaceState({},"",e)}},cleanLS:function(){localStorage.removeItem("line_token"),localStorage.removeItem("line_userID"),localStorage.removeItem("line_displayName"),localStorage.removeItem("line_exp"),localStorage.removeItem("email_exp")},setExpTime:function(e,t){var o=1<arguments.length&&void 0!==t?t:3,n=new Date,a=new Date(n.getFullYear(),n.getMonth(),n.getDate()+o);localStorage.setItem(e,a.getTime())},getParameterByName:function(e){return new URL(location.href).searchParams.get(e)},ajaxSensor:function(o,e){var n=1<arguments.length&&void 0!==e?e:this.apiURL,t=new AxiosMockAdapter(axios,{delayResponse:2e3});return t.onPost(n).reply(function(){return[200,{result:1,msg:""}]}),this.dev||t.restore(),new Promise(function(t){var e=new URLSearchParams;e.append("",JSON.stringify(o)),axios.post(n,e).then(function(e){return e.data.result?(t(),void console.log(e.data)):(Swal.fire({type:"error",title:"Oops...",text:"伺服器錯誤，請稍候再試！"}),void console.error(e.data.msg))}).catch(function(e){Swal.fire({type:"error",title:"Oops...",text:"伺服器錯誤，請稍候再試！"}),console.error(e)})})}},created:function(){this.manualLogout(),this.addCover()},mounted:function(){this.userID&&this.addSubscribeForm(),this.checkLogin()?this.saveViewLog():this.init()}});
//# sourceMappingURL=login.min.js.map
